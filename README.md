# AI Image Platform

A platform that allows users to upload images, train an AI model with these images using the Astria API, and receive new images generated by the model.

## Project Overview

This platform uses Supabase as a backend (including Storage and Database), and there are two main functions:
- `start-training`: Initiates the AI model training process
- `training-done`: Handles callbacks when training is complete and images are generated

## Architecture

The platform follows this workflow:

1. **Uploading images**:
   - User uploads images to Supabase Storage under the user-images bucket
   - Images are saved with an order_id (UUID) prefix, e.g.: order_id-image1.jpg

2. **Creating an order with start-training**:
   - The function accepts user_name, email, category, gender, and order_id
   - Saves the order in the orders table with status "training"
   - Finds images in user-images by the prefix order_id-
   - Sends images to Astria API to create a "tune" (trained AI model)
   - Saves the returned tune_id in the orders table

3. **Training and creating images with training-done**:
   - Astria API calls this function twice:
     - First: When training is complete (with tune_id and trained_at)
     - Second: When images are ready (with prompt_id and image links)
   - Updates order status and sends email to user with image links

## Technical Details

### Supabase Configuration
- URL: https://wrveqjducybephioulsb.supabase.co
- Service Role Key: Stored as environment variable SUPABASE_SERVICE_ROLE_KEY
- Uses Supabase Edge Functions (Deno runtime)

### Astria API
- URL: https://api.astria.ai/tunes (for creating tunes)
- URL: https://api.astria.ai/tunes/:tune_id/prompts (for creating images)
- API Key: Stored as environment variable ASTRIA_API_KEY
- Callback URL: https://wrveqjducybephioulsb.supabase.co/functions/v1/training-done

### Email Notifications
- Uses Resend API for sending emails
- API Key: Stored as environment variable RESEND_API_KEY

## Database Structure

The orders table in Supabase has the following structure:
- id (text, primary key): the order_id (UUID)
- user_name (text): the username
- email (text): the user's email
- category (text): category ("business", "social", "creative")
- gender (text): gender ("woman", "man")
- tune_id (text): the ID of the tune from Astria
- status (text): the order status ("training", "completed")
- result_urls (jsonb): a list of links to the images created
- prompts (jsonb): a list of prompts used for image generation
- created_at (timestamp): when the order was created

## Setup and Deployment

1. Clone the repository
2. Copy `.env.example` to `.env` and fill in your API keys
3. Deploy the Supabase functions:
   ```
   supabase functions deploy start-training
   supabase functions deploy training-done
   ```
4. Run the database migrations to create the orders table
5. Set up the storage bucket for user images

## Testing

To test the complete workflow:
1. Upload images to the user-images bucket with a specific order_id prefix
2. Call the start-training function with user details and the same order_id
3. The function will process the images and send them to Astria API
4. Astria API will call back to training-done when processing is complete
5. Check the orders table for status updates and result URLs
6. Verify that an email is sent to the user with image links

## Environment Variables

Required environment variables:
- SUPABASE_URL: Your Supabase project URL
- SUPABASE_SERVICE_ROLE_KEY: Your Supabase service role key
- ASTRIA_API_KEY: Your Astria API key
- RESEND_API_KEY: Your Resend API key for email sending
